{"version":3,"file":"embed.min.js","sources":["../src/embed.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/* eslint-disable no-undef, no-console, no-unused-vars, max-len */\ndefine(['jquery', 'mod_hvp/communicator'], function($, H5PEmbedCommunicator) {\n\n    // Wait for instances to be initialize.\n    $(document).ready(function() {\n        $('.h5p-iframe').ready(function() {\n            initEmbedCommunicator = function() {\n                var resizeDelay;\n                var instance = H5P.instances[0];\n                var parentIsFriendly = false;\n                var completionheight = 0;\n                if (globalThis.completion) {\n                    var completionactivity = document.getElementsByClassName('activity-header')[0];\n                    var completionmargin = document.defaultView.getComputedStyle(completionactivity, '')\n                        .getPropertyValue('margin-bottom');\n                    completionheight = completionactivity.scrollHeight + parseInt(completionmargin, 10); // We want the first element.\n                }\n\n                // Handle that the resizer is loaded after the iframe.\n                H5PEmbedCommunicator.on('ready', function() {\n                    H5PEmbedCommunicator.send('hello');\n                });\n\n                // Handle hello message from our parent window.\n                H5PEmbedCommunicator.on('hello', function() {\n                    // Initial setup/handshake is done.\n                    parentIsFriendly = true;\n\n                    // Hide scrollbars for correct size.\n                    iFrame.contentDocument.body.style.overflow = 'hidden';\n\n                    document.body.classList.add('h5p-resizing');\n\n                    // Content need to be resized to fit the new iframe size.\n                    H5P.trigger(instance, 'resize');\n                });\n                // When resize has been prepared tell parent window to resize.\n                H5PEmbedCommunicator.on('resizePrepared', function() {\n                    H5PEmbedCommunicator.send('resize', {\n                        scrollHeight: iFrame.contentDocument.body.scrollHeight + ((globalThis.completion) ? completionheight : 0)\n                    });\n                });\n\n                H5PEmbedCommunicator.on('resize', function() {\n                    H5P.trigger(instance, 'resize');\n                });\n\n                H5P.on(instance, 'resize', function() {\n                    if (H5P.isFullscreen) {\n                        return; // Skip iframe resize.\n                    }\n\n                    // Use a delay to make sure iframe is resized to the correct size.\n                    // Catalyst change - set the timeout to 1ms to get a more accurate height for some libraries.\n                    clearTimeout(resizeDelay);\n                    resizeDelay = setTimeout(function() {\n                        // Only resize if the iframe can be resized.\n                        if (parentIsFriendly) {\n                            H5PEmbedCommunicator.send('prepareResize',\n                                {\n                                    scrollHeight: iFrame.contentDocument.body.scrollHeight,\n                                    clientHeight: iFrame.contentDocument.body.clientHeight + ((globalThis.completion) ? completionheight : 0)\n                                }\n                            );\n                        } else {\n                            H5PEmbedCommunicator.send('hello');\n                        }\n                    }, 1);\n                });\n\n                // Trigger initial resize for instance.\n                H5P.trigger(instance, 'resize');\n            };\n            var iFrame = document.querySelector('.h5p-iframe');\n            var H5P = iFrame.contentWindow.H5P;\n            // Check for H5P instances.\n            if (!H5P || !H5P.instances || !H5P.instances[0]) {\n                console.warn(\"H5P embed.js: ACK! Embedded H5P.instances[0] in lowest iframe is not set up yet. Waiting for 'initialized' event\");\n                window.H5P.externalDispatcher.on('initialized', function(event) {\n                    console.log(\"H5P embed.js: 'initialized' event received\");\n                    H5P = iFrame.contentWindow.H5P;\n                    initEmbedCommunicator();\n                });\n            } else {\n                initEmbedCommunicator();\n            }\n        });\n    });\n\n    return  /** @alias module:mod_hvp/embed */ {\n        /**\n         * Initialise embed instance.\n         * @param {boolean} completion a boolean about displaying the completion information\n         */\n        init: function (completion) {\n            globalThis.completion = completion;\n        },\n    };\n});\n"],"names":["define","$","H5PEmbedCommunicator","document","ready","initEmbedCommunicator","resizeDelay","instance","H5P","instances","parentIsFriendly","completionheight","globalThis","completion","completionactivity","getElementsByClassName","completionmargin","defaultView","getComputedStyle","getPropertyValue","scrollHeight","parseInt","on","send","iFrame","contentDocument","body","style","overflow","classList","add","trigger","isFullscreen","clearTimeout","setTimeout","clientHeight","querySelector","contentWindow","console","warn","window","externalDispatcher","event","log","init"],"mappings":"AAeAA,uBAAO,CAAC,SAAU,yBAAyB,SAASC,EAAGC,6BAGnDD,EAAEE,UAAUC,OAAM,WACdH,EAAE,eAAeG,OAAM,WACnBC,sBAAwB,eAChBC,YACAC,SAAWC,IAAIC,UAAU,GACzBC,kBAAmB,EACnBC,iBAAmB,KACnBC,WAAWC,WAAY,KACnBC,mBAAqBX,SAASY,uBAAuB,mBAAmB,GACxEC,iBAAmBb,SAASc,YAAYC,iBAAiBJ,mBAAoB,IAC5EK,iBAAiB,iBACtBR,iBAAmBG,mBAAmBM,aAAeC,SAASL,iBAAkB,IAIpFd,qBAAqBoB,GAAG,SAAS,WAC7BpB,qBAAqBqB,KAAK,YAI9BrB,qBAAqBoB,GAAG,SAAS,WAE7BZ,kBAAmB,EAGnBc,OAAOC,gBAAgBC,KAAKC,MAAMC,SAAW,SAE7CzB,SAASuB,KAAKG,UAAUC,IAAI,gBAG5BtB,IAAIuB,QAAQxB,SAAU,aAG1BL,qBAAqBoB,GAAG,kBAAkB,WACtCpB,qBAAqBqB,KAAK,SAAU,CAChCH,aAAcI,OAAOC,gBAAgBC,KAAKN,cAAiBR,WAAWC,WAAcF,iBAAmB,QAI/GT,qBAAqBoB,GAAG,UAAU,WAC9Bd,IAAIuB,QAAQxB,SAAU,aAG1BC,IAAIc,GAAGf,SAAU,UAAU,WACnBC,IAAIwB,eAMRC,aAAa3B,aACbA,YAAc4B,YAAW,WAEjBxB,iBACAR,qBAAqBqB,KAAK,gBACtB,CACIH,aAAcI,OAAOC,gBAAgBC,KAAKN,aAC1Ce,aAAcX,OAAOC,gBAAgBC,KAAKS,cAAiBvB,WAAWC,WAAcF,iBAAmB,KAI/GT,qBAAqBqB,KAAK,WAE/B,OAIPf,IAAIuB,QAAQxB,SAAU,eAEtBiB,OAASrB,SAASiC,cAAc,eAChC5B,IAAMgB,OAAOa,cAAc7B,IAE1BA,KAAQA,IAAIC,WAAcD,IAAIC,UAAU,GAQzCJ,yBAPAiC,QAAQC,KAAK,oHACbC,OAAOhC,IAAIiC,mBAAmBnB,GAAG,eAAe,SAASoB,OACrDJ,QAAQK,IAAI,8CACZnC,IAAMgB,OAAOa,cAAc7B,IAC3BH,kCAQ2B,CAKvCuC,KAAM,SAAU/B,YACZD,WAAWC,WAAaA"}